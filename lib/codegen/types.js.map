{"version":3,"file":"types.js","sourceRoot":"","sources":["../../src/codegen/types.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from \"fs\";\r\n\r\nconst VERSION = JSON.parse(fs.readFileSync(__dirname + \"/../../package.json\").toString()).version;\r\nconst COMMENT_HEADER = `\r\nTHIS FILE HAS BEEN GENERATED AUTOMATICALLY\r\nDO NOT CHANGE IT MANUALLY UNLESS YOU KNOW WHAT YOU'RE DOING\r\n\r\nGENERATED USING @colyseus/schema ${VERSION}\r\n`;\r\n\r\nexport function getCommentHeader(singleLineComment: string = \"//\") {\r\n    return `${COMMENT_HEADER.split(\"\\n\").map(line => `${singleLineComment} ${line}`).join(\"\\n\")}`;\r\n}\r\n\r\nexport class Context {\r\n    classes: Class[] = [];\r\n    interfaces: Interface[] = [];\r\n    enums: Enum[] = [];\r\n\r\n    getStructures() {\r\n        return {\r\n            classes: this.classes.filter(klass => {\r\n                if (this.isSchemaClass(klass)) {\r\n                    return true;\r\n\r\n                } else {\r\n                    let parentClass = klass;\r\n                    while (parentClass = this.getParentClass(parentClass)) {\r\n                        if (this.isSchemaClass(parentClass)) {\r\n                            return true;\r\n                        }\r\n                    }\r\n                }\r\n                return false;\r\n            }),\r\n            interfaces: this.interfaces,\r\n            enums: this.enums,\r\n        };\r\n    }\r\n\r\n    addStructure(structure: IStructure) {\r\n        if (structure.context === this) { return; } // skip if already added.\r\n        structure.context = this;\r\n\r\n        if (structure instanceof Class) {\r\n            this.classes.push(structure);\r\n        } else if (structure instanceof Interface) {\r\n            this.interfaces.push(structure);\r\n        } else if (structure instanceof Enum) {\r\n            this.enums.push(structure);\r\n        }\r\n    }\r\n\r\n    private getParentClass(klass: Class) {\r\n        return this.classes.find(c => c.name === klass.extends);\r\n    }\r\n\r\n    private isSchemaClass(klass: Class) {\r\n        let isSchema: boolean = false;\r\n\r\n        let currentClass = klass;\r\n        while (!isSchema && currentClass) {\r\n            //\r\n            // TODO: ideally we should check for actual @colyseus/schema module\r\n            // reference rather than arbitrary strings.\r\n            //\r\n            isSchema = (\r\n                currentClass.extends === \"Schema\" ||\r\n                currentClass.extends === \"schema.Schema\" ||\r\n                currentClass.extends === \"Schema.Schema\"\r\n            );\r\n\r\n            //\r\n            // When extending from `schema.Schema`, it is required to\r\n            // normalize as \"Schema\" for code generation.\r\n            //\r\n            if (currentClass === klass && isSchema) {\r\n                klass.extends = \"Schema\";\r\n            }\r\n\r\n            currentClass = this.getParentClass(currentClass);\r\n        }\r\n\r\n        return isSchema;\r\n    }\r\n}\r\n\r\nexport interface IStructure {\r\n    context: Context;\r\n    name: string;\r\n    properties: Property[];\r\n    addProperty(property: Property): void;\r\n}\r\n\r\nexport class Interface implements IStructure {\r\n    context: Context;\r\n    name: string;\r\n    properties: Property[] = [];\r\n\r\n    addProperty(property: Property): void {\r\n        if (property.type.indexOf(\"[]\") >= 0) {\r\n            // is array!\r\n            property.childType = property.type.match(/([^\\[]+)/i)[1];\r\n            property.type = \"array\";\r\n            this.properties.push(property);\r\n\r\n        } else {\r\n            this.properties.push(property);\r\n        }\r\n    }\r\n}\r\n\r\nexport class Class implements IStructure {\r\n    context: Context;\r\n    name: string;\r\n    properties: Property[] = [];\r\n    extends: string;\r\n\r\n    addProperty(property: Property) {\r\n        property.index = this.properties.length;\r\n        this.properties.push(property);\r\n    }\r\n\r\n    postProcessing() {\r\n        /**\r\n         * Ensure the proprierties `index` are correct using inheritance\r\n         */\r\n        let parentKlass: Class = this;\r\n\r\n        while (\r\n            parentKlass &&\r\n            (parentKlass = this.context.classes.find(k => k.name === parentKlass.extends))\r\n        ) {\r\n            this.properties.forEach(prop => {\r\n                prop.index += parentKlass.properties.length;\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\nexport class Enum implements IStructure {\r\n    context: Context;\r\n    name: string;\r\n    properties: Property[] = [];\r\n\r\n    addProperty(property: Property) {\r\n        this.properties.push(property);\r\n    }\r\n}\r\n\r\nexport class Property {\r\n    index: number;\r\n    name: string;\r\n    type: string;\r\n    childType: string;\r\n    deprecated?: boolean;\r\n}\r\n\r\nexport interface File {\r\n    name: string\r\n    content: string;\r\n}\r\n\r\nexport function getInheritanceTree(klass: Class, allClasses: Class[], includeSelf: boolean = true) {\r\n    let currentClass = klass;\r\n    let inheritanceTree: Class[] = [];\r\n\r\n    if (includeSelf) {\r\n        inheritanceTree.push(currentClass);\r\n    }\r\n\r\n    while (currentClass.extends !== \"Schema\") {\r\n        currentClass = allClasses.find(klass => klass.name == currentClass.extends);\r\n        inheritanceTree.push(currentClass);\r\n    }\r\n\r\n    return inheritanceTree;\r\n}\r\n"]}