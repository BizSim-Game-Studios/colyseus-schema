{"version":3,"file":"ReferenceTracker.js","sourceRoot":"","sources":["../../src/decoder/ReferenceTracker.ts"],"names":[],"mappings":"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","sourcesContent":["import { Metadata } from \"../Metadata\";\r\nimport { $childType } from \"../types/symbols\";\r\nimport { Ref } from \"../encoder/ChangeTree\";\r\nimport { spliceOne } from \"../types/utils\";\r\nimport { OPERATION } from \"../encoding/spec\";\r\n\r\nimport type { MapSchema } from \"../types/custom/MapSchema\";\r\nimport type { Schema } from \"../Schema\";\r\n\r\nclass DecodingWarning extends Error {\r\n    constructor(message: string) {\r\n        super(message);\r\n        this.name = \"DecodingWarning\";\r\n    }\r\n}\r\n\r\n/**\r\n * Used for decoding only.\r\n */\r\n\r\nexport type SchemaCallbacks = { [field: string | number]: Function[] };\r\n\r\nexport class ReferenceTracker {\r\n    //\r\n    // Relation of refId => Schema structure\r\n    // For direct access of structures during decoding time.\r\n    //\r\n    public refs = new Map<number, Ref>();\r\n    public refIds = new WeakMap<Ref, number>();\r\n\r\n    public refCount: { [refId: number]: number; } = {};\r\n    public deletedRefs = new Set<number>();\r\n\r\n    public callbacks: { [refId: number]: SchemaCallbacks } = {};\r\n    protected nextUniqueId: number = 0;\r\n\r\n    getNextUniqueId() {\r\n        return this.nextUniqueId++;\r\n    }\r\n\r\n    // for decoding\r\n    addRef(refId: number, ref: Ref, incrementCount: boolean = true) {\r\n        this.refs.set(refId, ref);\r\n        this.refIds.set(ref, refId);\r\n\r\n        if (incrementCount) {\r\n            this.refCount[refId] = (this.refCount[refId] || 0) + 1;\r\n        }\r\n\r\n        if (this.deletedRefs.has(refId)) {\r\n            this.deletedRefs.delete(refId);\r\n        }\r\n    }\r\n\r\n    // for decoding\r\n    removeRef(refId: number) {\r\n        const refCount = this.refCount[refId];\r\n\r\n        if (refCount === undefined) {\r\n            try {\r\n                throw new DecodingWarning(\"trying to remove refId that doesn't exist: \" + refId);\r\n            } catch (e) {\r\n                console.warn(e);\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (refCount === 0) {\r\n            try {\r\n                const ref = this.refs.get(refId);\r\n                throw new DecodingWarning(`trying to remove refId '${refId}' with 0 refCount (${ref.constructor.name}: ${JSON.stringify(ref)})`);\r\n            } catch (e) {\r\n                console.warn(e);\r\n            }\r\n            return;\r\n        }\r\n\r\n        if ((this.refCount[refId] = refCount - 1) <= 0) {\r\n            this.deletedRefs.add(refId);\r\n        }\r\n    }\r\n\r\n    clearRefs() {\r\n        this.refs.clear();\r\n        this.deletedRefs.clear();\r\n        this.callbacks = {};\r\n        this.refCount = {};\r\n    }\r\n\r\n    // for decoding\r\n    garbageCollectDeletedRefs() {\r\n        this.deletedRefs.forEach((refId) => {\r\n            //\r\n            // Skip active references.\r\n            //\r\n            if (this.refCount[refId] > 0) { return; }\r\n\r\n            const ref = this.refs.get(refId);\r\n\r\n            //\r\n            // Ensure child schema instances have their references removed as well.\r\n            //\r\n            if ((ref.constructor as typeof Schema)[Symbol.metadata] !== undefined) {\r\n                const metadata: Metadata = (ref.constructor as typeof Schema)[Symbol.metadata];\r\n                for (const index in metadata) {\r\n                    const field = metadata[index as any as number].name;\r\n                    const childRefId = typeof(ref[field as keyof Ref]) === \"object\" && this.refIds.get((ref as any)[field]);\r\n                    if (childRefId && !this.deletedRefs.has(childRefId)) {\r\n                        this.removeRef(childRefId);\r\n                    }\r\n                }\r\n\r\n            } else {\r\n                if (typeof ((ref as any)[$childType]) === \"function\") {\r\n                    Array.from((ref as MapSchema).values())\r\n                        .forEach((child) => {\r\n                            const childRefId = this.refIds.get(child);\r\n                            if (!this.deletedRefs.has(childRefId)) {\r\n                                this.removeRef(childRefId);\r\n                            }\r\n                        });\r\n                }\r\n            }\r\n\r\n            this.refs.delete(refId); // remove ref\r\n            delete this.refCount[refId]; // remove ref count\r\n            delete this.callbacks[refId]; // remove callbacks\r\n        });\r\n\r\n        // clear deleted refs.\r\n        this.deletedRefs.clear();\r\n    }\r\n\r\n    addCallback(refId: number, fieldOrOperation: string | number, callback: Function) {\r\n        if (refId === undefined) {\r\n            const name = (typeof(fieldOrOperation) === \"number\")\r\n                    ? OPERATION[fieldOrOperation]\r\n                    : fieldOrOperation\r\n            throw new Error(\r\n                `Can't addCallback on '${name}' (refId is undefined)`\r\n            );\r\n        }\r\n        if (!this.callbacks[refId]) {\r\n            this.callbacks[refId] = {};\r\n        }\r\n        if (!this.callbacks[refId][fieldOrOperation]) {\r\n            this.callbacks[refId][fieldOrOperation] = [];\r\n        }\r\n        this.callbacks[refId][fieldOrOperation].push(callback);\r\n        return () => this.removeCallback(refId, fieldOrOperation, callback);\r\n    }\r\n\r\n    removeCallback(refId: number, field: string | number, callback: Function) {\r\n        const index: number | undefined = this.callbacks?.[refId]?.[field]?.indexOf(callback);\r\n        if (index !== undefined && index !== -1) {\r\n            spliceOne(this.callbacks[refId][field], index);\r\n        }\r\n    }\r\n\r\n}\r\n"]}